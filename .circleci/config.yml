version: 2.1
orbs:
  aws-ecr: circleci/aws-ecr@7.2.0
build-steps: &build-steps
  steps:
    - checkout
    - restore_cache:
        keys: 
          - key-{{ checksum "yarn.lock" }}-{{ checksum "package.json" }}
    - run:
        name: install dependency
        command: yarn
    - save_cache:
        key: key-{{ checksum "yarn.lock" }}-{{ checksum "package.json" }}
        paths:
          - node_modules/
    - run:
        name: build backend
        command: |
          yarn be:build
          yarn fe:build
          ls dist/
    - persist_to_workspace:
        root: .
        paths:
          - public
          - dist

deploy-be-steps: &deploy-be-steps
  steps:
    - checkout
    - attach_workspace:
        at:  .
    - setup_remote_docker
    - run:
        name: debug env variable
        command: env
    # - run:
    #     name: dockerize backend
    #     command: ./deployment/dockerize.sh
    # - run:
    #     name: deploy frontend to s3 
    #     command: |
    #       aws s3 sync public/ s3://${S3_BUCKET}/

deploy-fe-steps: &deploy-fe-steps
  steps:
    - attach_workspace:
        at:  .
    - run:
        name: deploy frontend to s3 
        command: |
          ls -la
          aws s3 sync public/ s3://${S3_BUCKET}/

jobs:
  build:
    working_directory: ~/workdir
    docker:
      - image: mhart/alpine-node:16
    <<: *build-steps

  deploy-fe:
    working_directory: ~/workdir
    docker:
      - image: amazon/aws-cli:2.2.26
    environment:
      S3_BUCKET: "demo.c2pig.com"
    <<: *deploy-fe-steps

workflows:
  version: 2
  ci:
    jobs:
      - approval:
          type: approval
      - build:
          requires:
            - approval
      - aws-ecr/build-and-push-image:
          context: credentials
          attach-workspace: true
          workspace-root: workspace
          path: workspace
          repo: payroll-backend
          tag: latest,${CIRCLE_SHA1}
          requires:
            - build
      - deploy-fe:
          context: credentials
          requires:
            - build
